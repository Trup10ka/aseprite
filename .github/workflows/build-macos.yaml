name: Build Aseprite for macOS

on:
  workflow_dispatch:  # Allows you to manually trigger the build
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'

jobs:
  build:
    name: Build for ${{ matrix.architecture }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - architecture: x64
            os: macos-13  # Intel Mac runner
            skia_arch: x64
            cmake_arch: x86_64
          - architecture: arm64
            os: macos-latest # Apple Silicon (M1) runner
            skia_arch: arm64
            cmake_arch: arm64

    steps:
    - name: Checkout Aseprite
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies (Ninja & CMake)
      run: |
        brew install ninja cmake
    
    - name: Download Skia (m124)
      run: |
        # Creates the deps folder as requested in the docs
        mkdir -p $HOME/deps
        cd $HOME/deps
        
        # Downloads the latest release from the aseprite-m124 branch
        # This automatically finds the correct zip for the architecture (x64 or arm64)
        REPO="aseprite/skia"
        TAG="m124-b384ac9237" # Pinned to a known working m124 tag to ensure stability
        ASSET_NAME="Skia-macOS-Release-${{ matrix.skia_arch }}.zip"
        
        echo "Downloading $ASSET_NAME..."
        curl -L -O "https://github.com/$REPO/releases/download/$TAG/$ASSET_NAME"
        
        # Unzip into the 'skia' folder
        unzip $ASSET_NAME -d skia
        
        echo "Skia setup complete."

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        
        # dynamically find the SDK path to avoid hardcoding errors on GitHub runners
        SDK_PATH=$(xcrun --show-sdk-path)
        
        cmake \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_OSX_ARCHITECTURES=${{ matrix.cmake_arch }} \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DCMAKE_OSX_SYSROOT=$SDK_PATH \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR=$HOME/deps/skia \
          -DSKIA_LIBRARY_DIR=$HOME/deps/skia/out/Release-${{ matrix.skia_arch }} \
          -DSKIA_LIBRARY=$HOME/deps/skia/out/Release-${{ matrix.skia_arch }}/libskia.a \
          -G Ninja \
          ..

    - name: Build Aseprite
      run: |
        cd build
        ninja aseprite

    - name: Package App Bundle
      run: |
        # The build creates a binary, but macOS needs a structure.
        # We assume the build process generated the binary at build/bin/aseprite
        cd build/bin
        
        # Create a simple zip of the output to make it easy to download
        zip -r aseprite-macos-${{ matrix.architecture }}.zip aseprite data

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Aseprite-macOS-${{ matrix.architecture }}
        path: build/bin/aseprite-macos-${{ matrix.architecture }}.zip
