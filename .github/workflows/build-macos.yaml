name: Build Aseprite for macOS

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'

jobs:
  build:
    name: Build for ${{ matrix.architecture }}
    # We now use macos-latest (Apple Silicon) for BOTH builds.
    # We will cross-compile the x64 version on the ARM machine.
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - architecture: x64
            cmake_arch: x86_64
            skia_arch: x64
          - architecture: arm64
            cmake_arch: arm64
            skia_arch: arm64

    steps:
    - name: Checkout Aseprite
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download Skia (m124)
      run: |
        mkdir -p $HOME/deps
        cd $HOME/deps
        
        REPO="aseprite/skia"
        TAG="m124-b384ac9237"
        ASSET_NAME="Skia-macOS-Release-${{ matrix.skia_arch }}.zip"
        
        echo "Downloading $ASSET_NAME..."
        curl -L -O "https://github.com/$REPO/releases/download/$TAG/$ASSET_NAME"
        
        unzip $ASSET_NAME -d skia
        echo "Skia setup complete."

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        
        SDK_PATH=$(xcrun --show-sdk-path)
        
        cmake \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_OSX_ARCHITECTURES=${{ matrix.cmake_arch }} \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DCMAKE_OSX_SYSROOT=$SDK_PATH \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR=$HOME/deps/skia \
          -DSKIA_LIBRARY_DIR=$HOME/deps/skia/out/Release-${{ matrix.skia_arch }} \
          -DSKIA_LIBRARY=$HOME/deps/skia/out/Release-${{ matrix.skia_arch }}/libskia.a \
          -G Ninja \
          ..

    - name: Build Aseprite
      run: |
        cd build
        # The -j1 flag is CRITICAL. It limits the build to 1 job at a time.
        # This prevents the runner from running out of RAM (Exit Code 9).
        ninja -j1 aseprite

    - name: Package App Bundle
      run: |
        cd build/bin
        zip -r aseprite-macos-${{ matrix.architecture }}.zip aseprite data

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Aseprite-macOS-${{ matrix.architecture }}
        path: build/bin/aseprite-macos-${{ matrix.architecture }}.zip
